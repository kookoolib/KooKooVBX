$(document).ready(function(){var a=$("select[name=flow_id]").hide();a.after('<span class="hide cancel"><a class="action close"><span class="replace">Cancel</span></a></span>');a.each(function(){var b=$(this);b.parent().children(".cancel").click(function(){b.parents("td").children("select, p, span").toggle()});b.parent().append('<p class="dropdown"><span class="option-selected">'+$("option:selected",b).text()+'</span><a class="action flow"><span class="replace">Select</span></a></p>').children("p.dropdown").click(function(){b.parents("td").children("select, p, span").toggle();
$(this).hide()})});$("button.add").click(function(){$("#dlg_add").dialog("open")});$("select[name=flow_id]").change(function(b){b.preventDefault();a=$(this);a.val()=="new"&&$(document).attr("location",OpenVBX.home+"flows");if(a.val().length<1){b=a.data("old_val");$("option:selected",a).removeAttr("selected");$("option[value="+b+"]",a).attr("selected","selected")}else if(a.data("old_val")!=a.val()&&a.val()>0&&a.data("old_val").length>0){a.parents("td").children("p.dropdown").html('<span class="option-selected">'+
$("option:selected",a).text()+'</span><a class="action flow"><span class="replace">Select</span></a>');$("#dlg_change").dialog("open")}else{a.parents("td").children("p.dropdown").html('<span class="option-selected">'+$("option:selected",a).text()+'</span><a class="action flow"><span class="replace">Select</span></a>');var d=a.closest("tr");b="numbers/change/"+d.attr("rel")+"/"+a.val();$.getJSON(b,function(c){if(c.success){$("option[value=0]",a).remove();a.data("old_val",c.id);$.notify($(".incoming-number-phone",
d).text()+" is now connected to "+$("option:selected",d).text());$(".incoming-number-flow",d).children("select, p, span").toggle()}else{c.message&&$.notify(c.message);a.val(a.data("old_val"))}})}}).each(function(){$(this).data("old_val",$("option:selected",this).attr("value"))});$("#dlg_change").dialog({width:640,buttons:{OK:function(){$("button").attr("disabled","disabled");var b=a.closest("tr"),d="numbers/change/"+b.attr("rel")+"/"+a.val();$.getJSON(d,function(c){if(c.success){$("option[value=0]",
a).remove();a.data("old_val",c.id);$.notify($(".incoming-number-phone",b).text()+" is now connected to "+$("option:selected",b).text());$(".incoming-number-flow",b).children("select, p, span").toggle()}else{c.message&&$.notify(c.message);a.val(a.data("old_val"))}$("button").removeAttr("disabled")});$(this).dialog("close")},Cancel:function(){a.val(a.data("old_val"));$(this).dialog("close")}}}).closest(".ui-dialog").addClass("add");var h=function(){var b=$("button",$("#dlg_add").parent()).first(),d=
b.text();b.html('Ordering <img alt="loading" src="'+OpenVBX.assets+'assets/i/ajax-loader.gif" />');$.ajax({type:"POST",url:$("#dlg_add form").attr("action"),data:$("input[type=text], input[type=radio]:checked",$("#dlg_add form")),success:function(c){$("button").attr("disabled","disabled");$("#dlg_add .error-message").slideUp();if(c.error){$("#dlg_add .error-message").text(c.message).slideDown();$("button").removeAttr("disabled");return b.text(d)}$(".ui-dialog-buttonpane button").remove();var e=c.number.id,
f=$("#completed-order .setup");f.unbind("click").removeAttr("disabled").live("click",function(i){f.append('<img alt="loading" src="'+OpenVBX.assets+'assets/i/ajax-loader.gif" />');i.preventDefault();$.ajax({url:OpenVBX.home+"flows",success:function(g){var j=g.url;$.ajax({url:OpenVBX.home+"numbers/change/"+e+"/"+g.id,success:function(){document.location=j},type:"POST"})},type:"POST"})});$(".number-order-interface").slideUp("ease-out",function(){$("#completed-order .number").text(c.number.phone);$("#completed-order").slideDown("ease-in");
b.text(d)});e=c.number.id;$("#completed-order").removeClass("hide")},error:function(c,e,f){$("#dlg_add .error-message").text(e+" :: "+f).slideDown();$("button").removeAttr("disabled")},dataType:"json"});return false};$("#dlg_add form").submit(h);$("#dlg_add").dialog({width:490,buttons:{"Add number":h,Cancel:function(){$("#dlg_add .error-message").hide();$(this).dialog("close")}}}).closest(".ui-dialog").addClass("add");$("#dlg_delete").dialog({width:640,buttons:{Yes:function(){var b=$(".delete.selected").attr("href");
$.ajax({type:"POST",url:b,data:{confirmed:true},success:function(d){if(d.error){$.notify(d.message);$("#dlg_delete .error-message").text(d.message).show()}else{$(".vbx-items-grid tr:has(.delete.selected)").fadeOut("fast",function(){$(this).removeClass(".selected");$.notify("Number has been removed from your account.")});$("#dlg_delete").dialog("close")}},error:function(d,c,e){$("#dlg_delete .error-message").text(c+" :: "+e).show()},dataType:"json"})},No:function(){$(this).dialog("close");$(".delete").removeClass("selected")}}}).closest(".ui-dialog").addClass("add");
$(":radio[name=type]").click(function(){$(this).val()=="local"?$("#pAreaCode").slideDown(function(){$("#iAreaCode").focus()}):$("#pAreaCode").slideUp()});$(".delete").click(function(){$(this).addClass("selected");$("#dlg_delete").dialog("open");return false})});
